<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>{% if q %}{{ q + ' - ' }}{% endif %}Internet Archive search</title>
<style>
body { font-family: serif; }
em { background: yellow; font-style: normal; }
span.selected { background: #ccc; padding: 2px; }
</style>
<script language="javascript" type="text/javascript" src="/javascript/jquery/jquery.js"></script>

<!--[if IE]><script language="javascript" type="text/javascript" src="/javascript/excanvas/excanvas.js"></script><![endif]-->

<script language="javascript" type="text/javascript" src="/javascript/flot/jquery.flot.js"></script>

</head>
<body>
<h1>Search</h1>
<form><input name="q" value="{{q or ''}}" size="60">
<input type="submit" value="Search">
</form>

{% macro facet_list(fc, k) %}
    {% if fc.get(k) %}
        {% set facet_heading = 'media type' if k == 'mediatype' else k.replace('_facet', '') %}
        <h2>{{ facet_heading }}</h2>
        {% for key, count in fc[k] %}
            {% if k == 'licenseurl' %}
                {% set label = fmt_licenseurl(key) %}
            {% else %}
                {% set label = key | truncate(48)%}
            {% endif %}
            {% if k == 'collection' and key in collection_titles %}
                {% set label = collection_titles[key] |truncate(48) %}
            {% elif k == 'language_facet' and key.lower() in lang_map %}
                {% set label=lang_map[key.lower()] %}
            {% endif %}
            {% if key in facet_args_dict[k] %}
                <a href="?{{changequery({'page':None,k:None})}}">[x]</a> <b>{{ label }}</b> ({{ comma(count) }}) <br>
            {% else %}
                <a href="?{{changequery({'page':None,k:key})}}">{{ label }}</a> ({{ comma(count) }})<br>
            {% endif %}
        {% endfor %}
    {% endif %}
{% endmacro %}

{% if results %}
    <br>
{% if did_you_mean %}
    {% if alt_results %}Showing results for{% else %}Did you mean{% endif %} 
    <a href="?q={%for i in did_you_mean%}{{quote(i[1])}}{%endfor%}">
{%for token, text in did_you_mean%}{% if token=='fix' %}<span style="font-weight:bold">{{text}}</span>{% else %}{{text}}{%endif%}{%endfor%}</a>{% if not alt_results %}?{% endif %}<br>
{% if alt_results %}
Search instead for <a href="?{{changequery({'nfpr': 1})}}">{{ request.args['q'] }}</a><p>
{% endif %}
{% endif %}

{% if facet_args or date_facet %}
    {% for k, v in facet_args %}
    <a href="?{{changequery({'page':None,k:None})}}">[x]</a> <b>{{ k }}: {{ v |truncate(48) }}</b>
    {% endfor %}
    {% if date_facet %}
    <a href="?{{changequery({'page':None,'date_facet':date_facet})}}">[x]</a> <b>decade: {{date_facet}}-{{date_facet+10}}</b>
    {% endif %}
    
    <p>
{% endif %}

{% if results.response.numFound == 0 %}
    <br>Your search - <b>{{ q }}</b> - did not match any documents.
{% else %}
    <!-- {{url|safe}} -->
    {{ comma(results.response.numFound) }} results<br>
    solr time: {{ '%.4f' | format(t_solr) }} seconds<p>

    {% set show_year_chart = False %}
    {% if show_year_chart and results.facet_counts.facet_ranges.date.counts %}
        <div id="placeholder" style="width:1000px;height:450px"></div>

        <script>

        $(function() {
            var years = [
            {%- for y, count in results.facet_counts.facet_ranges.date.counts -%} 
                [{{ y[:4] }}, {{ count }}]{% if not loop.last %},{% endif %}
            {%- endfor %} ];

            var options = { };

            var series = {
                data: years,
                bars: { 
                    show: true, 
                    fill: 0.6, 
                    align: "center"
                },
            };

            $.plot($("#placeholder"), [series], options);
        })
        </script>

    {% endif %}

    <table>
    <tr><td valign="top">
    {% set mediatypes = ['texts', 'movies', 'audio', 'image', 'etree', 'software'] %}
    <table>
    {% for doc in results.response.docs %}
        {% set details = "http://www.archive.org/details/" + doc.identifier %}
        {% set hl = results.highlighting[doc.identifier] %}
        <!-- {{ hl | pprint | safe }} -->
        <!-- {{ doc | pprint | safe }} -->
        <tr>
            <td>
            {% if doc.mediatype in mediatypes %}
                <img src="http://www.archive.org/images/mediatype_{{doc.mediatype|lower}}.gif">
            {% endif %}
            <a href="{{ details }}">
            {% if 'case-name' in doc %}{{ doc['case-name'][0] }} - {%endif -%}
            {% if hl.title and hl.title[0].strip() %}
                {% for token_type, token in token_hl(hl.title[0]) -%}
                    {% if token_type == 'text' %}{{token}}{% else %}<em>{{ token }}</em>{% endif -%}
                {% endfor -%}
            {%- elif doc.title and doc.title.strip() -%}
                {{ doc.title }}
            {% else %}
                {{ doc.identifier }}
            {%- endif -%}</a>
            {% if hl.creator %}
                {% for creator in hl.creator %}
                    {% for token_type, token in token_hl(creator) %}
                        {% if token_type == 'text' %}{{token}}{% else %}<em>{{ token }}</em>{% endif %}
                    {% endfor %}
                {% endfor %}
            {% else %}
                {{ ', '.join(doc.creator) }}
            {% endif %}

            {% if doc.noindex %}<span style="padding:2px;background:red;color:white">noindex</span>{% endif %}
            </td>

            {% if doc.mediatype=='movies' %}
                <td></td>
            {% else %}
                <td valign="top" rowspan="2" align="right">
                    {% if doc.mediatype == 'texts' and doc.scanner %}
                        <a href="{{details}}"><img src="http://www.archive.org/download/{{ doc.identifier }}/page/{{doc.identifier}}_cover_h100.jpg" height="150"></a>
                    {% elif doc.mediatype == 'image' %}
                        {% set thumb_url = get_img_thumb(doc.identifier) %}
                        {% if thumb_url %}
                            <a href="{{details}}"><img src="{{thumb_url}}"></a>
                        {% endif %}
                    {% endif %}
                </td>
            {% endif %}
        </tr>
        <tr>
        {% if doc.mediatype=='movies' %}
            <td colspan="2" valign="top">
            {% set thumb = get_movie_thumb(doc.identifier) %}
            {% if thumb %}
                {% for img in pick_best(thumb.imgs, num=4) %}
                    <a href="{{details}}"><img src="{{thumb.url + img }}"></a>
                {% endfor %}
                <br>
            {% endif %}
        {% else %}
            <td valign="top">
        {% endif %}
        {% if doc.description %}
            {% if hl.description %}
                {% set hl_desc = hl.description[0] %}
                {% set hl_desc2 = hl_desc.replace('{{{', '').replace('}}}', '') %}
                {% if hl_desc2[:20] != doc.description[:20] %}&hellip;{% endif %}
                {% for token_type, token in token_hl(hl_desc) %}
                    {% if token_type == 'text' %}
                        {% for line in token.splitlines() if line %}
                            {{ line }}{% if not loop.last %}<br>{% endif %}
                        {% endfor %}
                    {% else %}<em>{{ token }}</em>{% endif %}
                {% endfor %}
                {% if hl_desc2[-20:] != doc.description[-20:] %}&hellip;{% endif %}
            {% else %}
                {% for line in doc.description[:200].splitlines() if line %}
                    {{ line }}{% if not loop.last %}<br>{% endif %}
                {% endfor %}
                {% if len(doc.description) > 200 %}&hellip;{% endif %}
            {% endif %}
            <br>
        {% endif %}
        
        {% if doc.date %}<b>Date</b>: {{doc.date_str | default(doc.date[:10]) }}{% endif %}
        {% if doc.sponsor %}<b>Sponsor</b>: <a href="?{{changequery({'page':None,'sponsor':doc.sponsor})}}">{{doc.sponsor}}</a>{% endif %}
        {% if doc.rating %}<b>Rating</b>: {{doc.rating }}{% endif %}
        {% if doc.imagecount %}<b>Images</b>: {{doc.imagecount }}{% endif %}
        {% if doc.downloads %}<b>Downloads</b>: {{doc.downloads }}{% endif %}
        {% if doc.foldoutcount %}<b>Foldouts</b>: {{doc.foldoutcount }}{% endif %}
        (<a href="{{url_for('view_mlt', identifier=doc.identifier)}}">more like this</a>)
        <br>
        {% if doc.subject %}<b>Keywords</b>:
            {% if hl.subject %}
                {% for s in hl.subject %}
                    <a href="?{{changequery({'page':None,'subject_facet':s.replace('{{{', '').replace('}}}','')})}}">
                    {% for token_type, token in token_hl(s) %}
                        {% if token_type == 'text' %}{{token}}{% else %}<em>{{ token }}</em>{% endif %}
                    {% endfor %}</a>{% if not loop.last %}; {% endif %}
                {% endfor %}
            {% else %}
                {% for s in doc.subject %}
                    <a href="?{{changequery({'page':None,'subject_facet':s})}}">{{s}}</a>{% if not loop.last %}; {% endif %}
                {% endfor %}
            {% endif %}
            <br>
        {% endif %}
        {% if doc.collection %}<b>Collections</b>: 
            {% for c in doc.collection %}
                <a href="?{{changequery({'page':None,'collection':c})}}">{{collection_titles.get(c, c) }}</a>{% if not loop.last %}; {% endif %}
            {% endfor %}
            <br>
        {% endif %}
        <br>

        </td>
        </tr>
    {% endfor %}
    </table>
    </td>

    <td nowrap="nowrap" valign="top">
        {% set fc = results.facet_counts.facet_fields %}
        {% for k in ['noindex', 'mediatype'] %}
            {{ facet_list(fc, k) }}
        {% endfor %}

        {% if results.facet_counts.facet_ranges.date.counts %}
            <h2>decade</h2>
            {% for i in results.facet_counts.facet_ranges.date.counts | reverse %}
                {% set start_year = int(i[0][:4]) %}
                {% set end_year = 'now' if loop.first else start_year + year_gap %}
                {% set end_year = start_year + year_gap %}
                <a href="?{{changequery({'page':None,'date_facet':i[0][:4]})}}">{{start_year}}-{{end_year}}</a> ({{ comma(i[1]) }})<br>
            {% endfor %}
        {% endif %}

        {% for k in facet_fields if k not in ('noindex', 'mediatype') %}
            {{ facet_list(fc, k) }}
        {% endfor %}

        {% if results.facet_counts.facet_ranges.get('imagecount', {}).counts %}
            <h2>image count</h2>
            {% for i in results.facet_counts.facet_ranges.imagecount.counts | reverse %}
                {% set facet_min = int(i[0]) %}
                {% set facet_max = facet_min + 100 %}
                <a href="?{{changequery({'page':None,'imagecount':i[0]})}}">{{facet_min}}-{{facet_max}}</a> ({{ comma(i[1]) }})<br>
            {% endfor %}
        {% endif %}

        {% if results.facet_counts.facet_ranges.get('downloads', {}).counts %}
            <h2>downloads</h2>
            {% for i in results.facet_counts.facet_ranges.downloads.counts | reverse %}
                {% set facet_min = int(i[0]) %}
                {% set facet_max = facet_min + 1000 %}
                <a href="?{{changequery({'page':None,'downloads':i[0]})}}">{{facet_min}}-{{facet_max}}</a> ({{ comma(i[1]) }})<br>
            {% endfor %}
        {% endif %}

    </td></tr></table>

    Pages:

    {% if page != 1 %}
        <a href="?{{changequery({'page':None})}}">&laquo;&nbsp;First</a>
        <a href="?{{changequery({'page':page-1})}}">&lt;&nbsp;Previous</a>
    {% endif %}
    {% for p in pager.page_list %}
        {% if p == page %}
            <span class="this">{{p}}</span>
        {% else %}
            <a href="?{{changequery({'page':p})}}">{{p}}</a>
        {% endif %}
    {% endfor %}
    {% if page < pager.pages %}
        <a href="?{{changequery({'page':page+1})}}">Next&nbsp;&gt;</a>
        <a href="?{{changequery({'page':pager.pages})}}">Last&nbsp;&raquo;</a>
    {% endif %}

{% endif %}
{% endif %}
</body>
</html>
